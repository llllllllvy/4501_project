WITH unpivot_rent AS(
SELECT 
    zipcode,
    year_month,
    rent
FROM rents,
LATERAL (
    VALUES 
        ('2015-01', m2015_01),
('2015-02', m2015_02),
('2015-03', m2015_03),
('2015-04', m2015_04),
('2015-05', m2015_05),
('2015-06', m2015_06),
('2015-07', m2015_07),
('2015-08', m2015_08),
('2015-09', m2015_09),
('2015-10', m2015_10),
('2015-11', m2015_11),
('2015-12', m2015_12),
('2016-01', m2016_01),
('2016-02', m2016_02),
('2016-03', m2016_03),
('2016-04', m2016_04),
('2016-05', m2016_05),
('2016-06', m2016_06),
('2016-07', m2016_07),
('2016-08', m2016_08),
('2016-09', m2016_09),
('2016-10', m2016_10),
('2016-11', m2016_11),
('2016-12', m2016_12),
('2017-01', m2017_01),
('2017-02', m2017_02),
('2017-03', m2017_03),
('2017-04', m2017_04),
('2017-05', m2017_05),
('2017-06', m2017_06),
('2017-07', m2017_07),
('2017-08', m2017_08),
('2017-09', m2017_09),
('2017-10', m2017_10),
('2017-11', m2017_11),
('2017-12', m2017_12),
('2018-01', m2018_01),
('2018-02', m2018_02),
('2018-03', m2018_03),
('2018-04', m2018_04),
('2018-05', m2018_05),
('2018-06', m2018_06),
('2018-07', m2018_07),
('2018-08', m2018_08),
('2018-09', m2018_09),
('2018-10', m2018_10),
('2018-11', m2018_11),
('2018-12', m2018_12),
('2019-01', m2019_01),
('2019-02', m2019_02),
('2019-03', m2019_03),
('2019-04', m2019_04),
('2019-05', m2019_05),
('2019-06', m2019_06),
('2019-07', m2019_07),
('2019-08', m2019_08),
('2019-09', m2019_09),
('2019-10', m2019_10),
('2019-11', m2019_11),
('2019-12', m2019_12),
('2020-01', m2020_01),
('2020-02', m2020_02),
('2020-03', m2020_03),
('2020-04', m2020_04),
('2020-05', m2020_05),
('2020-06', m2020_06),
('2020-07', m2020_07),
('2020-08', m2020_08),
('2020-09', m2020_09),
('2020-10', m2020_10),
('2020-11', m2020_11),
('2020-12', m2020_12),
('2021-01', m2021_01),
('2021-02', m2021_02),
('2021-03', m2021_03),
('2021-04', m2021_04),
('2021-05', m2021_05),
('2021-06', m2021_06),
('2021-07', m2021_07),
('2021-08', m2021_08),
('2021-09', m2021_09),
('2021-10', m2021_10),
('2021-11', m2021_11),
('2021-12', m2021_12),
('2022-01', m2022_01),
('2022-02', m2022_02),
('2022-03', m2022_03),
('2022-04', m2022_04),
('2022-05', m2022_05),
('2022-06', m2022_06),
('2022-07', m2022_07),
('2022-08', m2022_08),
('2022-09', m2022_09),
('2022-10', m2022_10),
('2022-11', m2022_11),
('2022-12', m2022_12),
('2023-01', m2023_01),
('2023-02', m2023_02),
('2023-03', m2023_03),
('2023-04', m2023_04),
('2023-05', m2023_05),
('2023-06', m2023_06),
('2023-07', m2023_07),
('2023-08', m2023_08),
('2023-09', m2023_09)
) AS unpivoted(year_month, rent)),

tree_comp AS
              (SELECT t1.zipcode,
                      COUNT(t1.complaint_id) AS complaint_num,
                      t2.tree_num
               FROM complaints311 AS t1
               JOIN (SELECT zipcode,
                            COUNT(tree_id) AS tree_num
                     FROM trees
                     GROUP BY 1
                    ) AS t2 ON t1.zipcode = t2.zipcode
               WHERE created_date BETWEEN '2015-01-01T00:00:00.000' AND '2023-09-30T23:59:59.999'
               GROUP BY 1,3
               ORDER BY 1,2)
               
       SELECT t1.zipcode,
              ROUND(AVG(t2.rent)::numeric,2) AS average_rent,
              t1.tree_num,
              t1.complaint_num  
       FROM tree_comp AS t1
       JOIN unpivot_rent AS t2 on t1.zipcode  = t2.zipcode
       GROUP BY 1,3,4
       ORDER BY 1